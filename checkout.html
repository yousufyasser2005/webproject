<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checkout - MintLib</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="site-header">
<div class="container header-inner">
<a href="index.html" class="logo">ðŸ“š MintLib</a>
<nav class="main-nav">
<a href="about.html">About Us</a>
<a href="sell.html" class="contact-link">Sell</a>
<a href="cart.html" class="contact-link">Cart</a>
<a href="my-orders.html" class="contact-link">My Orders</a>
<a href="profile.html" class="contact-link">Profile</a>
</nav>
</div>
</header>

<main class="container">
<h1>Checkout</h1>

<div id="cartSummary" style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
    <h3>Order Summary</h3>
    <p id="cartItems">Loading cart...</p>
    <p><strong>Total: <span id="orderTotal">0</span> EGP</strong></p>
</div>

<form id="checkoutForm">
<label>Full Name:</label>
<input type="text" id="customerName" required><br>

<label>Street Address:</label>
<input type="text" id="street" required><br>

<label>City:</label>
<input type="text" id="city" required><br>

<label>State/Province:</label>
<input type="text" id="state" required><br>

<label>Zip Code:</label>
<input type="text" id="zipCode" required><br>

<label>Country:</label>
<input type="text" id="country" value="Egypt" required><br>

<label>Payment Method:</label>
<select id="paymentMethod">
<option value="cash">Cash on Delivery</option>
<option value="credit_card">Credit Card</option>
<option value="debit_card">Debit Card</option>
</select><br>

<button type="submit" class="btn">Submit Order</button>
</form>
<p id="checkoutMessage" class="message"></p>
</main>

<footer class="site-footer">
<div class="container">
<p>MintLib Â© 2025 - All Rights Reserved</p>
<p><a href="contact.html">Contact Us</a></p>
</div>
</footer>

<script src="js/api/config.js"></script>
<script>
let currentCart = null;

async function loadCartSummary() {
    const result = await apiCall('/cart', 'GET');
    console.log('Cart for checkout:', result);
    
    if (result.success && result.data) {
        currentCart = result.data;
        
        if (currentCart.items.length === 0) {
            document.getElementById('cartItems').innerHTML = '<p style="color: #ef4444;">Your cart is empty! <a href="index.html">Continue shopping</a></p>';
            document.getElementById('checkoutForm').style.display = 'none';
            return;
        }
        
        const itemsList = currentCart.items.map(item => 
            `${item.title || 'Product'} x ${item.quantity} = ${item.price * item.quantity} EGP`
        ).join('<br>');
        
        document.getElementById('cartItems').innerHTML = itemsList;
        document.getElementById('orderTotal').textContent = currentCart.totalAmount;
    } else {
        document.getElementById('cartItems').innerHTML = '<p style="color: #ef4444;">Failed to load cart</p>';
    }
}

document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = document.getElementById('checkoutMessage');
    message.textContent = 'Processing order...';
    message.className = 'message';
    
    const shippingAddress = {
        street: document.getElementById('street').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        zipCode: document.getElementById('zipCode').value,
        country: document.getElementById('country').value
    };
    
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    console.log('Placing order with:', { shippingAddress, paymentMethod });
    
    const result = await apiCall('/orders', 'POST', {
        shippingAddress,
        paymentMethod
    });
    
    console.log('Order result:', result);
    
    if (result.success) {
        message.className = 'success-message';
        message.textContent = 'âœ… Order placed successfully! Redirecting...';
        setTimeout(() => {
            window.location.href = 'my-orders.html';
        }, 1500);
    } else {
        message.className = 'error-message';
        message.textContent = 'âŒ ' + (result.message || 'Failed to place order');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }
    
    loadCartSummary();
});
</script>
<script src="script.js"></script>
</body>
</html>
